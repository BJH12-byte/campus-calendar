<!DOCTYPE html>
<html lang="ko">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=393, height=852, initial-scale=1.0" />
		<title>게시글 상세보기 - 캠퍼스 캘린더</title>
		<link rel="stylesheet" href="homepg_written.css" />
		<style>
			.edit-delete-option {
				width: 120px;
				padding: 10px;
				font-size: 16px;
				color: white;
				background: #7c74c9;
				text-align: center;
				cursor: pointer;
			}
			.edit-delete-option:first-child {
				border-top-left-radius: 12px;
				border-top-right-radius: 12px;
			}
			.edit-delete-option:last-child {
				border-bottom-left-radius: 12px;
				border-bottom-right-radius: 12px;
				background: #b7b7f9;
			}
		</style>
	</head>
	<body>
		<div id="app-container">
			<!-- 헤더 -->
			<div class="header-top">
				<div class="logo-container">
					<img src="lefttop-logo-white.svg" alt="로고" class="logo" />
				</div>
			</div>
			<div class="header-controls">
				<button
					class="back-btn"
					onclick="location.href='../kimgabelow/boards/all.html'"
				>
					<img src="goback.svg" alt="뒤로가기" />
				</button>
				<div class="page-title">과목명 불러오는 중...</div>
				<div class="header-actions">
					<button class="save-button">
						<img src="savebtn.svg" alt="저장" />
					</button>
					<button class="more-button">
						<img src="morebtn.svg" alt="더보기" />
					</button>
				</div>
			</div>

			<!-- 더보기 팝업 -->
			<div
				id="more-option-popup"
				style="
					display: none;
					position: absolute;
					top: 100px;
					right: 20px;
					background: white;
					border-radius: 12px;
					overflow: hidden;
					box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
					z-index: 9999;
				"
			>
				<div class="edit-delete-option" id="option-edit">수정</div>
				<div style="height: 1px; background: #ddd"></div>
				<div class="edit-delete-option" id="option-delete">삭제</div>
			</div>

			<!-- 수정모드 팝업 (새로 추가) -->
			<div
				id="edit-popup"
				style="
					display: none;
					position: absolute;
					top: 100px;
					right: 20px;

					background: white;
					border-radius: 12px;
					overflow: hidden;
					box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
					z-index: 9999;
				"
			>
				<div class="edit-delete-option" id="save-edit">저장</div>
				<div style="height: 1px; background: #ddd"></div>
				<div class="edit-delete-option" id="cancel-edit">취소</div>
			</div>

			<!-- 본문 -->
			<main class="post-content">
				<h2 id="post-title">게시글 제목</h2>
				<div class="post-meta">
					<span id="post-date">YYYY.MM.DD</span>
					<span class="divider">|</span>
					<span id="post-subject">과목명/카테고리</span>
				</div>
				<p id="post-body">게시글 내용이 여기에 표시됩니다.</p>
				<div class="image-container">
					<img id="post-image" src="" alt="게시글 이미지" />
				</div>
			</main>

			<!-- 하단탭 -->
			<footer class="notice-footer">
				<div class="bottom-bar"></div>
				<div class="bottom-nav">
					<div class="nav-item" onclick="location.href='../basic/home.html'">
						<div class="nav-circle">
							<img
								src="https://img.icons8.com/ios-filled/50/ffffff/home.png"
								alt="피드"
							/>
							<span class="circle-label">피드</span>
						</div>
					</div>
					<div class="nav-item active" onclick="location.href='homepage2.html'">
						<div class="nav-circle">
							<img
								src="https://img.icons8.com/ios-filled/50/ffffff/compass--v1.png"
								alt="공지"
							/>
							<span class="circle-label">공지</span>
						</div>
					</div>
					<div
						class="nav-item"
						onclick="location.href='../notification/notification.html'"
					>
						<div class="nav-circle">
							<img
								src="https://img.icons8.com/ios-filled/50/ffffff/appointment-reminders.png"
								alt="알림"
							/>
							<span class="circle-label">알림</span>
						</div>
					</div>
					<div class="nav-item" onclick="location.href='../Mypage/mypage.html'">
						<div class="nav-circle">
							<img
								src="https://img.icons8.com/ios-filled/50/ffffff/user.png"
								alt="MY"
							/>
							<span class="circle-label">MY</span>
						</div>
					</div>
				</div>
			</footer>
		</div>

		<script src="popup.js"></script>
		<script>
			document.addEventListener('DOMContentLoaded', () => {
				const selectedSubject = localStorage.getItem('selectedSubject');
				const latestPostStr = selectedSubject
					? localStorage.getItem(`latestPost_${selectedSubject}`)
					: null;

				if (latestPostStr) {
					const post = JSON.parse(latestPostStr);
					displayPost(post);
					document.querySelector('.page-title').textContent =
						post.subject || '과목 정보 없음';
					document.getElementById('post-subject').innerText =
						post.subject || '과목명 없음';
					document.getElementById('post-date').innerText =
						post.date || 'YYYY.MM.DD';
				} else {
					document.getElementById('post-body').innerText =
						'작성된 게시글이 없습니다.';
				}

				// 저장 버튼 클릭: 스크랩 (프로필 저장 전용)
				document.querySelector('.save-button').addEventListener('click', () => {
					const post = {
						title: document.getElementById('post-title').innerText,
						content: document.getElementById('post-body').innerText,
						date: document.getElementById('post-date').innerText,
						subject: document.getElementById('post-subject').innerText,
						image: document.getElementById('post-image').src,
					};
					localStorage.setItem('myProfilePost', JSON.stringify(post));
					showCustomPopup('게시글이 내 프로필에 저장되었습니다!');
				});

				// 더보기 버튼 클릭: 팝업 토글
				const moreBtn = document.querySelector('.more-button');
				const morePopup = document.getElementById('more-option-popup');
				moreBtn.addEventListener('click', (e) => {
					e.stopPropagation();
					morePopup.style.display =
						morePopup.style.display === 'block' ? 'none' : 'block';
				});

				document.addEventListener('click', (e) => {
					if (
						morePopup.style.display === 'block' &&
						!morePopup.contains(e.target) &&
						!moreBtn.contains(e.target)
					) {
						morePopup.style.display = 'none';
					}
				});

				// 수정 버튼 → 수정모드 진입 + 수정팝업 표시
				let originalTitle = '';
				let originalBody = '';
				document.getElementById('option-edit').addEventListener('click', () => {
					if (!selectedSubject) {
						showCustomPopup('과목 정보가 없습니다.');
						return;
					}

					const titleEl = document.getElementById('post-title');
					const bodyEl = document.getElementById('post-body');

					originalTitle = titleEl.innerText;
					originalBody = bodyEl.innerText;

					titleEl.setAttribute('contenteditable', 'true');
					bodyEl.setAttribute('contenteditable', 'true');

					document.getElementById('edit-popup').style.display = 'block';

					// 더보기 팝업 강제 닫기
					morePopup.style.display = 'none';

					showCustomPopup(
						'수정 모드로 전환했습니다.\n수정 후 저장/취소 버튼을 사용하세요.'
					);
				});

				// 저장 버튼 (수정팝업)
				document.getElementById('save-edit').addEventListener('click', () => {
					const titleEl = document.getElementById('post-title');
					const bodyEl = document.getElementById('post-body');

					const latestPostStr = localStorage.getItem(
						`latestPost_${selectedSubject}`
					);
					if (!latestPostStr) {
						showCustomPopup('저장할 게시글이 없습니다.');
						return;
					}

					const latestPost = JSON.parse(latestPostStr);
					const updatedTitle = titleEl.innerText;
					const updatedBody = bodyEl.innerText;

					const subjectKey = `posts_${selectedSubject}`;
					let posts = JSON.parse(localStorage.getItem(subjectKey)) || [];
					const index = posts.findIndex(
						(p) => p.title === latestPost.title && p.date === latestPost.date
					);

					if (index !== -1) {
						posts[index].title = updatedTitle;
						posts[index].content = updatedBody;
						localStorage.setItem(subjectKey, JSON.stringify(posts));
					}

					latestPost.title = updatedTitle;
					latestPost.content = updatedBody;
					localStorage.setItem(
						`latestPost_${selectedSubject}`,
						JSON.stringify(latestPost)
					);

					titleEl.setAttribute('contenteditable', 'false');
					bodyEl.setAttribute('contenteditable', 'false');
					document.getElementById('edit-popup').style.display = 'none';

					showCustomPopup('게시글이 수정되었습니다.');
				});

				// 취소 버튼 (수정팝업)
				document.getElementById('cancel-edit').addEventListener('click', () => {
					const titleEl = document.getElementById('post-title');
					const bodyEl = document.getElementById('post-body');

					titleEl.innerText = originalTitle;
					bodyEl.innerText = originalBody;

					titleEl.setAttribute('contenteditable', 'false');
					bodyEl.setAttribute('contenteditable', 'false');
					document.getElementById('edit-popup').style.display = 'none';

					showCustomPopup('수정을 취소했습니다.');
				});

				// 삭제 버튼
				document
					.getElementById('option-delete')
					.addEventListener('click', () => {
						if (!selectedSubject) {
							showCustomPopup('과목 정보가 없습니다.');
							return;
						}

						const latestPostStr = localStorage.getItem(
							`latestPost_${selectedSubject}`
						);
						if (!latestPostStr) {
							showCustomPopup('삭제할 게시글이 없습니다.');
							return;
						}

						const post = JSON.parse(latestPostStr);

						const subjectKey = `posts_${selectedSubject}`;
						let posts = JSON.parse(localStorage.getItem(subjectKey)) || [];
						const updatedPosts = posts.filter(
							(p) => !(p.title === post.title && p.date === post.date)
						);
						localStorage.setItem(subjectKey, JSON.stringify(updatedPosts));
						localStorage.removeItem(`latestPost_${selectedSubject}`);

						showCustomPopup('게시글이 삭제되었습니다.', () => {
							location.href = 'subjectboard.html';
						});
					});
			});

			function displayPost(post) {
				document.getElementById('post-title').innerText =
					post.title || '제목 없음';
				document.getElementById('post-body').innerText =
					post.content || '내용 없음';
				document.getElementById('post-subject').innerText =
					post.subject || '과목명 없음';
				if (post.image) {
					document.getElementById('post-image').src = post.image;
					document.getElementById('post-image').style.display = 'block';
				} else {
					document.getElementById('post-image').style.display = 'none';
				}
			}
		</script>
	</body>
</html>
