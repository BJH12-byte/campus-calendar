<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=393, height=852, initial-scale=1.0" />
    <title>게시글 상세보기 - 캠퍼스 캘린더</title>
    <link rel="stylesheet" href="homepg_written.css" />
    <style>
      .edit-delete-option {
        width: 120px;
        padding: 10px;
        font-size: 16px;
        color: white;
        background: #7c74c9;
        text-align: center;
        cursor: pointer;
      }
      .edit-delete-option:first-child {
        border-top-left-radius: 12px;
        border-top-right-radius: 12px;
      }
      .edit-delete-option:last-child {
        border-bottom-left-radius: 12px;
        border-bottom-right-radius: 12px;
        background: #b7b7f9;
      }
    </style>
  </head>
  <body>
    <div id="app-container">
      <!-- 헤더 -->
      <div class="header-top">
        <div class="logo-container">
          <img src="lefttop-logo-white.svg" alt="로고" class="logo" />
        </div>
      </div>
      <div class="header-controls">
        <button class="back-btn" onclick="location.href='subjectboard.html'">
          <img src="goback.svg" alt="뒤로가기" />
        </button>
        <div class="page-title">과목명 불러오는 중...</div>
        <div class="header-actions">
          <button class="save-button">
            <img src="savebtn.svg" alt="저장" />
          </button>
          <button class="more-button">
            <img src="morebtn.svg" alt="더보기" />
          </button>
        </div>
      </div>

      <!-- 수정/삭제 팝업 -->
      <div
        id="more-option-popup"
        style="
          display: none;
          position: absolute;
          top: 100px;
          right: 20px;
          background: white;
          border-radius: 12px;
          overflow: hidden;
          box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
          z-index: 9999;
        "
      >
        <div class="edit-delete-option" id="option-edit">수정</div>
        <div style="height: 1px; background: #ddd"></div>
        <div class="edit-delete-option" id="option-delete">삭제</div>
      </div>

      <!-- 본문 -->
      <main class="post-content">
        <h2 id="post-title">게시글 제목</h2>
        <div class="post-meta">
          <span id="post-date">YYYY.MM.DD</span>
          <span class="divider">|</span>
          <span id="post-subject">과목명/카테고리</span>
        </div>
        <p id="post-body">게시글 내용이 여기에 표시됩니다.</p>
        <div class="image-container">
          <img id="post-image" src="" alt="게시글 이미지" />
        </div>
      </main>

      <!-- 하단탭 -->
      <footer class="notice-footer">
        <div class="bottom-bar"></div>
        <div class="bottom-nav">
          <div class="nav-item" onclick="location.href='../basic/home.html'">
            <div class="nav-circle">
              <img
                src="https://img.icons8.com/ios-filled/50/ffffff/home.png"
                alt="피드"
              />
              <span class="circle-label">피드</span>
            </div>
          </div>
          <div class="nav-item active" onclick="location.href='homepage2.html'">
            <div class="nav-circle">
              <img
                src="https://img.icons8.com/ios-filled/50/ffffff/compass--v1.png"
                alt="공지"
              />
              <span class="circle-label">공지</span>
            </div>
          </div>
          <div
            class="nav-item"
            onclick="location.href='../notification/notification.html'"
          >
            <div class="nav-circle">
              <img
                src="https://img.icons8.com/ios-filled/50/ffffff/appointment-reminders.png"
                alt="알림"
              />
              <span class="circle-label">알림</span>
            </div>
          </div>
          <div class="nav-item" onclick="location.href='../Mypage/mypage.html'">
            <div class="nav-circle">
              <img
                src="https://img.icons8.com/ios-filled/50/ffffff/user.png"
                alt="MY"
              />
              <span class="circle-label">MY</span>
            </div>
          </div>
        </div>
      </footer>
    </div>

    <script>
      document.addEventListener('DOMContentLoaded', async () => {
        const urlParams = new URLSearchParams(window.location.search);
        const postId = urlParams.get('id');
        if (!postId) {
          document.getElementById('post-body').innerText =
            '글 정보를 찾을 수 없습니다.';
          return;
        }

        // 1. 공지 상세 조회 (API)
        let post;
        try {
          const res = await fetch(
            `https://unidays-project.com/api/notices/${postId}`,
            {
              credentials: 'include',
            }
          );
          if (!res.ok) throw new Error('게시글 불러오기 실패');
          post = await res.json();
        } catch (e) {
          document.getElementById('post-body').innerText =
            '불러오는 중 오류 발생';
          console.error(e);
          return;
        }

        // 2. 제목/본문/날짜/과목명 렌더링
        document.getElementById('post-title').innerText =
          post.title || '제목 없음';
        document.getElementById('post-body').innerText =
          post.content || '내용 없음';
        document.getElementById('post-date').innerText = (
          post.date || ''
        ).replace(/-/g, '.');
        document.getElementById('post-subject').innerText =
          post.subject?.name || '과목명 없음';

        // 3. 이미지 또는 파일 썸네일
        const imgEl = document.getElementById('post-image');
        if (post.imageUrl || post.fileUrl) {
          imgEl.src = post.imageUrl || post.fileUrl;
          imgEl.style.display = 'block';
        } else {
          imgEl.style.display = 'none';
        }

        // 4. 저장 버튼
        document.querySelector('.save-button').addEventListener('click', () => {
          localStorage.setItem('myProfilePost', JSON.stringify(post));
          alert('게시글이 내 프로필에 저장되었습니다!');
        });

        // 5. 더보기 팝업 토글
        const moreBtn = document.querySelector('.more-button');
        const morePopup = document.getElementById('more-option-popup');
        moreBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          morePopup.style.display =
            morePopup.style.display === 'block' ? 'none' : 'block';
        });
        document.addEventListener('click', (e) => {
          if (
            morePopup.style.display === 'block' &&
            !morePopup.contains(e.target) &&
            !moreBtn.contains(e.target)
          ) {
            morePopup.style.display = 'none';
          }
        });

        // 6. 수정/삭제 버튼 핸들러
        morePopup
          .querySelector('#option-edit')
          .addEventListener('click', () => {
            window.location.href = `subject-write.html?id=${postId}`;
          });
        morePopup
          .querySelector('#option-delete')
          .addEventListener('click', async () => {
            if (!confirm('정말 삭제할까요?')) return;
            try {
              const res = await fetch(
                `https://unidays-project.com/api/notices/${postId}`,
                {
                  method: 'DELETE',
                  credentials: 'include',
                }
              );
              if (!res.ok) throw new Error('삭제 실패');
              alert('게시글이 삭제되었습니다.');
              window.location.href = 'subjectboard.html';
            } catch (e) {
              alert('삭제 중 오류 발생');
              console.error(e);
            }
          });
      });
    </script>
  </body>
</html>
