<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=393, height=852, initial-scale=1.0" />
    <title>게시글 상세보기 - 캠퍼스 캘린더</title>
    <link rel="stylesheet" href="homepg_written.css" />
    <style>
      .edit-delete-option {
        width: 120px;
        padding: 10px;
        font-size: 16px;
        color: white;
        background: #7c74c9;
        text-align: center;
        cursor: pointer;
      }
      .edit-delete-option:first-child {
        border-top-left-radius: 12px;
        border-top-right-radius: 12px;
      }
      .edit-delete-option:last-child {
        border-bottom-left-radius: 12px;
        border-bottom-right-radius: 12px;
        background: #b7b7f9;
      }
    </style>
  </head>
  <body>
    <div id="app-container">
      <!-- ... header & markup unchanged ... -->
    </div>

    <script>
      document.addEventListener('DOMContentLoaded', async () => {
        // URL에서 postId만 받는다 (id)
        const urlParams = new URLSearchParams(window.location.search);
        const postId = urlParams.get('id');
        if (!postId) {
          document.getElementById('post-body').innerText =
            '글 정보를 찾을 수 없습니다.';
          return;
        }

        let post = null;
        try {
          // API로 단일 공지 데이터 받아오기
          const res = await fetch(
            `https://unidays-project.com/api/notices/${postId}`,
            {
              credentials: 'include',
            }
          );
          if (!res.ok) throw new Error('게시글 불러오기 실패');
          post = await res.json();
        } catch (e) {
          document.getElementById('post-body').innerText =
            '게시글 정보를 불러올 수 없습니다.';
          return;
        }

        // 과목명 렌더
        document.querySelector('.page-title').innerText =
          post.subject?.name || '과목 없음';

        // 본문/날짜/제목/이미지 표시
        document.getElementById('post-title').innerText =
          post.title || '제목 없음';
        document.getElementById('post-body').innerText =
          post.content || '내용 없음';
        document.getElementById('post-date').innerText =
          post.date?.replace(/-/g, '.') || 'YYYY.MM.DD';
        document.getElementById('post-subject').innerText =
          post.subject?.name || '과목명 없음';

        // 이미지 표시 (imageUrl, fileUrl 우선순)
        const imageUrl = post.imageUrl || post.fileUrl;
        if (imageUrl) {
          document.getElementById('post-image').src = imageUrl;
          document.getElementById('post-image').style.display = 'block';
        } else {
          document.getElementById('post-image').style.display = 'none';
        }

        // 저장 버튼 (API 기반에선 내보내기용)
        document.querySelector('.save-button').addEventListener('click', () => {
          localStorage.setItem('myProfilePost', JSON.stringify(post));
          alert('게시글이 내 프로필에 저장되었습니다!');
        });

        // 더보기/수정/삭제 팝업
        const moreBtn = document.querySelector('.more-button');
        const morePopup = document.getElementById('more-option-popup');
        moreBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          morePopup.style.display =
            morePopup.style.display === 'block' ? 'none' : 'block';
        });
        document.addEventListener('click', (e) => {
          if (
            morePopup.style.display === 'block' &&
            !morePopup.contains(e.target) &&
            !moreBtn.contains(e.target)
          ) {
            morePopup.style.display = 'none';
          }
        });

        // 수정 버튼: 글쓰기 페이지로 이동 (id만 넘김)
        document.getElementById('option-edit').addEventListener('click', () => {
          location.href = `subject-write.html?id=${postId}`;
        });

        // 삭제 버튼: API로 삭제 후 목록 페이지로 이동
        document
          .getElementById('option-delete')
          .addEventListener('click', async () => {
            if (!confirm('정말 삭제할까요?')) return;
            try {
              const delRes = await fetch(
                `https://unidays-project.com/api/notices/${postId}`,
                { method: 'DELETE', credentials: 'include' }
              );
              if (!delRes.ok) throw new Error('삭제 실패');
              alert('게시글이 삭제되었습니다.');
              location.href =
                'subjectboard.html?subjectId=' + (post.subject?.id || '');
            } catch (e) {
              alert('삭제 중 오류: ' + (e.message || ''));
            }
          });
      });
    </script>
  </body>
</html>
