<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=393, height=852, initial-scale=1.0" />
    <title>게시글 상세보기 - 캠퍼스 캘린더</title>
    <link rel="stylesheet" href="homepg_written.css" />
    <style>
      .edit-delete-option {
        width: 120px;
        padding: 10px;
        font-size: 16px;
        color: white;
        background: #7c74c9;
        text-align: center;
        cursor: pointer;
      }
      .edit-delete-option:first-child {
        border-top-left-radius: 12px;
        border-top-right-radius: 12px;
      }
      .edit-delete-option:last-child {
        border-bottom-left-radius: 12px;
        border-bottom-right-radius: 12px;
        background: #b7b7f9;
      }
    </style>
  </head>
  <body>
    <div id="app-container">
      <!-- ... header & markup unchanged ... -->
    </div>

    <script>
      document.addEventListener('DOMContentLoaded', async () => {
        // 1) URL 파라미터에서 postId(id)만 읽는다
        const urlParams = new URLSearchParams(window.location.search);
        const postId = urlParams.get('id');
        if (!postId) {
          document.getElementById('post-body').innerText =
            '글 정보를 찾을 수 없습니다.';
          return;
        }

        let post;
        try {
          // 2) API 호출로 단일 게시글 상세 조회
          const res = await fetch(
            `https://unidays-project.com/api/notices/${postId}`,
            {
              credentials: 'include',
            }
          );
          if (!res.ok) throw new Error('게시글 불러오기 실패');
          post = await res.json();
        } catch (err) {
          document.getElementById('post-body').innerText =
            '불러오는 중 오류 발생';
          console.error(err);
          return;
        }

        // 3) 데이터 렌더링
        document.getElementById('post-title').innerText =
          post.title || '제목 없음';
        document.getElementById('post-body').innerText =
          post.content || '내용 없음';
        document.getElementById('post-date').innerText = (
          post.date || ''
        ).replace(/-/g, '.');
        document.getElementById('post-subject').innerText =
          post.subject?.name || '과목명 없음';

        const imgEl = document.getElementById('post-image');
        if (post.imageUrl || post.fileUrl) {
          imgEl.src = post.imageUrl || post.fileUrl;
          imgEl.style.display = 'block';
        } else {
          imgEl.style.display = 'none';
        }

        // 4) 저장 버튼
        document.querySelector('.save-button').addEventListener('click', () => {
          localStorage.setItem('myProfilePost', JSON.stringify(post));
          alert('게시글이 내 프로필에 저장되었습니다!');
        });

        // 5) 더보기 팝업 열고 닫기
        const moreBtn = document.querySelector('.more-button');
        const morePopup = document.getElementById('more-option-popup');
        moreBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          morePopup.style.display =
            morePopup.style.display === 'block' ? 'none' : 'block';
        });
        document.addEventListener('click', (e) => {
          if (
            morePopup.style.display === 'block' &&
            !morePopup.contains(e.target) &&
            !moreBtn.contains(e.target)
          ) {
            morePopup.style.display = 'none';
          }
        });

        // 6) 수정 버튼 → id만 넘겨
        morePopup
          .querySelector('#option-edit')
          .addEventListener('click', () => {
            window.location.href = `subject-write.html?id=${postId}`;
          });

        // 7) 삭제 버튼 → API 호출
        morePopup
          .querySelector('#option-delete')
          .addEventListener('click', async () => {
            if (!confirm('정말 삭제할까요?')) return;
            try {
              const res = await fetch(
                `https://unidays-project.com/api/notices/${postId}`,
                {
                  method: 'DELETE',
                  credentials: 'include',
                }
              );
              if (!res.ok) throw new Error('삭제 실패');
              alert('게시글이 삭제되었습니다.');
              window.location.href = 'subjectboard.html';
            } catch (err) {
              alert('삭제 중 오류 발생');
              console.error(err);
            }
          });
      });
    </script>
  </body>
</html>
